<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Koreksi Jawaban AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus_Jakarta_Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* UKURAN DASAR (KOMPUTER/TABLET) */
        html { font-size: 18px; } 
        body { font-size: 1rem; font-family: 'Plus_Jakarta_Sans', sans-serif; }

        .force-show { display: block !important; opacity: 1 !important; visibility: visible !important; }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        .spinner-mini {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s ease-in-out infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal-animate {
            animation: modalBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalBounce {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        #forgotBtn, #authToggleBtn {
            font-size: 1rem !important;
            font-weight: 800;
        }

        .otp-input {
            letter-spacing: 0.5rem;
            text-align: center;
            font-size: 2rem !important;
        }

        /* Gaya Khusus Pesan Peringatan Merah */
        .notice-red {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border-left: 6px solid #e53e3e;
        }

        @media (max-width: 767px) {
            html { font-size: 15px; } 
            body { padding: 12px; }
            .rounded-\[45px\], .rounded-\[40px\] { border-radius: 28px !important; }
            .rounded-\[35px\], .rounded-\[30px\] { border-radius: 20px !important; }
            .p-10 { padding: 1.5rem !important; }
            .p-8 { padding: 1.2rem !important; }
            .py-8 { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; }
            .text-5xl { font-size: 2.5rem !important; }
            .text-3xl { font-size: 1.75rem !important; }
            .text-4xl { font-size: 2.2rem !important; }
            .text-6xl { font-size: 3rem !important; }
            #gridPG { gap: 8px !important; }
            select.key-dropdown {
                font-size: 1.1rem !important;
                padding: 0.8rem 0.4rem !important;
            }
        }

        @media (min-width: 1024px) {
            #dashboardWrapper { 
                max-width: 1200px !important; 
                display: grid; 
                grid-template-columns: 480px 1fr; 
                gap: 2rem; 
                align-items: start; 
            }
            .header-area, #adminPanel, .upload-section, .notice-area { grid-column: span 2; }
            #resWrap { margin-top: 0 !important; padding-top: 0 !important; }
        }

        @media (min-width: 768px) {
            #authWrapper > div { max-width: 500px !important; margin: 2rem auto !important; padding: 2rem; background: #ffffff; border-radius: 50px; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
            #dashboardWrapper { max-width: 650px; margin: 2rem auto !important; }
            body { background-color: #f1f5f9; }
        }

        select.key-dropdown {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2em;
            font-size: 1.4rem !important;
            padding: 1rem !important;
        }

        details summary::-webkit-details-marker { display:none; }
        details summary { list-style: none; }
    </style>
</head>
<body class="bg-slate-50 p-4 text-slate-900">

    <div id="customAlertOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-sm rounded-[40px] p-8 shadow-2xl modal-animate text-center border border-slate-100">
            <div id="alertIcon" class="text-7xl mb-4">‚ö†Ô∏è</div>
            <h3 id="alertTitle" class="text-2xl font-black uppercase text-slate-800 mb-2">Pemberitahuan</h3>
            <p id="alertMsg" class="text-lg font-bold text-slate-500 leading-relaxed mb-8 whitespace-pre-line"></p>
            <div id="alertButtons" class="space-y-3"></div>
        </div>
    </div>

    <div id="otpModalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[210] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[40px] p-8 shadow-2xl modal-animate border border-slate-100">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üìß</div>
                <h3 class="text-2xl font-black uppercase text-slate-800">Verifikasi Kode</h3>
                <p class="text-slate-500 font-bold">Masukkan kode 6 digit dari email & password baru</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="otpCode" placeholder="000000" maxlength="6" class="otp-input w-full p-5 bg-slate-50 rounded-2xl font-black border border-slate-100 outline-none focus:border-blue-400">
                <input type="password" id="otpNewPass" placeholder="Password Baru" class="w-full p-5 bg-slate-50 rounded-2xl text-lg font-bold border border-slate-100 outline-none focus:border-blue-400">
                <button onclick="submitVerifyOTP()" class="w-full bg-blue-600 text-white font-black py-6 rounded-[30px] text-sm uppercase shadow-xl active:scale-95 transition">GANTI PASSWORD</button>
                <button onclick="document.getElementById('otpModalOverlay').classList.add('hidden')" class="w-full text-slate-400 font-black py-2 text-xs uppercase">Batal</button>
            </div>
        </div>
    </div>

    <div id="tokenBadge" class="fixed top-4 right-4 z-[110] hidden">
        <div class="bg-white/90 backdrop-blur-md border border-blue-100 px-6 py-4 rounded-full shadow-xl flex items-center gap-3">
            <span class="text-xs font-black text-slate-400 uppercase italic">Token:</span>
            <span id="valToken" class="text-3xl font-black text-blue-600">0</span>
        </div>
    </div>

    <div id="authWrapper" class="fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center p-6">
        <div class="max-w-md w-full space-y-8 text-center">
            <h1 class="text-5xl font-black italic uppercase">JAWABAN <span class="text-blue-600">AI</span></h1>
            <div class="bg-white p-10 rounded-[45px] shadow-sm border border-slate-100 space-y-6">
                <p id="authTitle" class="text-sm font-black text-blue-600 uppercase tracking-widest">Selamat Datang Kembali</p>
                <input type="email" id="authEmail" placeholder="Email Anda" class="w-full p-6 bg-slate-50 rounded-2xl text-lg font-bold border border-slate-100 outline-none focus:border-blue-400">
                <input type="password" id="authPass" placeholder="Password" class="w-full p-6 bg-slate-50 rounded-2xl text-lg font-bold border border-slate-100 outline-none focus:border-blue-400">
                <button id="btnAuthAction" onclick="submitAuth()" class="w-full bg-[#0f172a] text-white font-black py-7 rounded-[30px] text-sm uppercase shadow-xl active:scale-95 transition">MASUK SEKARANG</button>
                <div class="flex justify-between px-2 text-xs font-bold uppercase">
                    <button id="forgotBtn" onclick="changeAuthMode('forgot')" class="text-slate-400 hover:text-slate-600">Lupa?</button>
                    <button id="authToggleBtn" onclick="changeAuthMode('reg')" class="text-blue-600 hover:text-blue-800">Daftar Akun</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardWrapper" class="max-w-md mx-auto space-y-6 opacity-0 pointer-events-none transition-opacity duration-500">
        
        <div class="header-area flex justify-between items-center py-6">
            <h1 class="text-3xl font-black italic uppercase">JAWABAN <span class="text-blue-600">AI</span></h1>
            <button onclick="logout()" class="bg-red-50 text-red-500 px-6 py-3 rounded-full text-xs font-black uppercase">Keluar</button>
        </div>

        <div id="adminPanel" class="hidden bg-slate-900 p-8 rounded-[40px] border-2 border-blue-500 shadow-xl mb-6">
            <p class="text-xs font-black text-blue-400 uppercase mb-4 tracking-widest text-center italic">üíé Admin Dashboard</p>
            <div class="space-y-4">
                <input type="email" id="targetEmail" placeholder="Email User" class="w-full p-5 bg-slate-800 text-white rounded-2xl text-lg font-bold border border-slate-700">
                <select id="paketToken" class="w-full p-5 bg-slate-800 text-white rounded-2xl text-lg font-bold border border-slate-700">
                    <option value="100">100 Token</option>
                    <option value="210">210 Token</option>
                    <option value="350">350 Token</option>
                </select>
                <button onclick="prosesTambahToken()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl text-xs uppercase">Tambah Token</button>
            </div>
        </div>

        <div class="notice-area notice-red p-6 rounded-[30px] shadow-sm border border-red-200">
            <div class="flex items-center gap-3 mb-2">
                <span class="text-2xl">‚ö†Ô∏è</span>
                <p class="text-xs font-black text-red-600 uppercase tracking-widest italic leading-none">PENTING: PERHATIKAN URUTAN</p>
            </div>
            <p class="text-[13px] font-bold text-red-500 leading-relaxed mb-1">
                Tolong upload foto siswa **sesuai urutan**. Jika soal ada 2 lembar, pastikan foto lembar yang ada namanya dipilih **lebih dulu**.
            </p>
            <p class="text-[14px] font-black text-red-700 uppercase tracking-tighter bg-red-100 inline-block px-2 py-1 rounded-lg border border-red-300">
                üöÄ MAX 10 FOTO PER SESI
            </p>
        </div>

        <div class="upload-section grid grid-cols-2 gap-4">
            <button onclick="triggerUpload('camera')" class="bg-white p-10 rounded-[35px] border-2 border-dashed border-slate-200 flex flex-col items-center hover:bg-slate-50 active:scale-95 transition">
                <span class="text-5xl mb-2">üì∏</span>
                <span class="text-xs font-black uppercase text-slate-500">Ambil Foto</span>
            </button>
            <button onclick="triggerUpload('gallery')" class="bg-white p-10 rounded-[35px] border-2 border-dashed border-slate-200 flex flex-col items-center hover:bg-slate-50 active:scale-95 transition">
                <span class="text-5xl mb-2">üñºÔ∏è</span>
                <span class="text-xs font-black uppercase text-slate-500">Pilih Galeri</span>
            </button>
            <input type="file" id="file" multiple class="hidden" onchange="handleFileSelect(this)" accept="image/*">
            <div id="stts" class="col-span-2 text-xs font-black text-blue-600 uppercase text-center italic">Belum ada file dipilih</div>
        </div>

        <div class="left-col space-y-6">
            <div class="bg-white p-8 rounded-[45px] shadow-sm border border-slate-100">
                <p class="text-xs font-black text-blue-600 uppercase mb-6 tracking-widest">Kunci PG (1-20)</p>
                <div id="gridPG" class="grid grid-cols-5 gap-y-6 gap-x-3 mb-10"></div>
                
                <p class="text-xs font-black text-emerald-500 uppercase mb-5 tracking-widest">Kunci Essay</p>
                <div id="gridES" class="space-y-4"></div>
            </div>

            <button id="btnAI" class="w-full bg-[#0f172a] text-white font-black py-8 rounded-[40px] text-lg uppercase shadow-xl transition active:scale-95">
                MULAI PROSES KOREKSI AI
            </button>
            <p id="loadingMsg" class="hidden text-center text-xs font-black text-blue-500 italic mt-2 animate-pulse">ü§ñ Gemini sedang menganalisis gambar...</p>
        </div>

        <div id="resWrap" class="hidden space-y-6 pt-10">
            <div class="flex justify-between items-center px-2">
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest italic">Hasil Scan Terbaru</p>
                <button onclick="konfirmasiHapusRiwayat()" class="text-xs font-black text-red-500 uppercase">Bersihkan</button>
            </div>

            <div id="scanAwal" class="space-y-5"></div>

            <div class="bg-white p-10 rounded-[45px] border-t-[6px] border-blue-600 space-y-6 shadow-xl mt-14">
                <p class="text-center font-black text-blue-600 text-xs uppercase italic">Masukan Rumus Penilaian</p>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 italic">Rumus PG:</p>
                        <input type="text" id="r_pg" placeholder="betul * 1" class="w-full p-5 bg-slate-50 rounded-2xl text-sm font-bold border border-slate-100 outline-none">
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-emerald-500 uppercase mb-2 ml-1 italic">Rumus Essay:</p>
                        <input type="text" id="r_es" placeholder="betul * 10" class="w-full p-5 bg-slate-50 rounded-2xl text-sm font-bold border border-slate-100 outline-none">
                    </div>
                </div>
                <button id="btnHitung" class="w-full bg-blue-600 text-white font-black py-7 rounded-[30px] text-sm uppercase shadow-lg">HITUNG NILAI AKHIR</button>
            </div>

            <div id="exportMenu" class="hidden grid grid-cols-3 gap-2 px-2">
                <button onclick="exportWord()" class="bg-blue-100 text-blue-700 py-4 rounded-2xl text-[10px] font-black uppercase border border-blue-200">DOCX</button>
                <button onclick="exportPDF()" class="bg-red-100 text-red-700 py-4 rounded-2xl text-[10px] font-black uppercase border border-red-200">PDF</button>
                <button onclick="exportExcel()" class="bg-emerald-100 text-emerald-700 py-4 rounded-2xl text-[10px] font-black uppercase border border-emerald-200">EXCEL</button>
            </div>

            <div id="laporanFinal" class="space-y-6 pb-40"></div>
        </div>
    </div>

    <script>
        let dbData = [];
        let exportData = []; // Data untuk proses ekspor
        let currentMode = 'login';
        let currentToken = 0;

        function showAlert(msg, mode = 'alert') {
            const overlay = document.getElementById('customAlertOverlay');
            const msgEl = document.getElementById('alertMsg');
            const titleEl = document.getElementById('alertTitle');
            const iconEl = document.getElementById('alertIcon');
            const btnArea = document.getElementById('alertButtons');
            msgEl.innerText = msg;
            btnArea.innerHTML = '';

            if (mode === 'confirm') {
                titleEl.innerText = "Konfirmasi"; iconEl.innerText = "üóëÔ∏è";
                btnArea.innerHTML = `
                    <button onclick="hapusRiwayat()" class="w-full bg-red-500 text-white font-black py-6 rounded-[25px] text-sm uppercase">Ya, Hapus Semua</button>
                    <button onclick="closeAlert()" class="w-full bg-slate-100 text-slate-500 font-black py-5 rounded-[25px] text-xs uppercase">Batal</button>`;
            } else if (msg.toLowerCase().includes("habis")) {
                titleEl.innerText = "Token Habis!"; iconEl.innerText = "üé´";
                btnArea.innerHTML = `
                    <a href="https://wa.me/6282240400388?text=Halo%20Admin,%20Token%20Habis" target="_blank" class="block w-full bg-green-500 text-white font-black py-6 rounded-[25px] text-sm text-center uppercase">Hubungi Admin (WA)</a>
                    <button onclick="closeAlert()" class="w-full bg-slate-100 text-slate-500 font-black py-5 rounded-[25px] text-xs uppercase">Tutup</button>`;
            } else {
                titleEl.innerText = msg.includes("Berhasil") || msg.includes("KODE TERKIRIM") ? "Sukses!" : "Pemberitahuan";
                iconEl.innerText = msg.includes("Berhasil") || msg.includes("KODE TERKIRIM") ? "‚úÖ" : "‚ö†Ô∏è";
                btnArea.innerHTML = `<button onclick="closeAlert()" class="w-full bg-blue-600 text-white font-black py-6 rounded-[25px] text-sm uppercase">Oke</button>`;
            }
            overlay.classList.remove('hidden');
        }

        function closeAlert() { document.getElementById('customAlertOverlay').classList.add('hidden'); }
        function konfirmasiHapusRiwayat() { showAlert("Bersihkan semua laporan?", 'confirm'); }
        function hapusRiwayat() { dbData = []; localStorage.removeItem('riwayat_ai_v2'); location.reload(); }

        const gPG = document.getElementById('gridPG');
        gPG.innerHTML = ''; 
        for(let i=1; i<=20; i++) {
            gPG.innerHTML += `
                <div class="flex flex-col items-center gap-2">
                    <span class="text-xs font-black text-slate-400 uppercase italic leading-none">${i}</span>
                    <select id="p${i}" class="key-dropdown w-full p-4 bg-slate-50 rounded-xl text-2xl font-black border border-slate-100 outline-none text-center">
                        <option value="">-</option>
                        <option>A</option>
                        <option>B</option>
                        <option>C</option>
                        <option>D</option>
                    </select>
                </div>`;
        }
        const gES = document.getElementById('gridES');
        gES.innerHTML = '';
        for(let i=1; i<=5; i++) {
            gES.innerHTML += `
                <div class="relative">
                    <span class="absolute left-5 top-1/2 -translate-y-1/2 text-xs font-black text-slate-300 italic uppercase">No ${i}</span>
                    <input id="e${i}" placeholder="Kunci Jawaban Essay..." class="w-full pl-20 p-5 bg-slate-50 rounded-2xl text-lg font-bold border border-slate-100 outline-none">
                </div>`;
        }

        function tampilkanHasilKeLayar() {
            const container = document.getElementById('scanAwal');
            if(!dbData.length) return;
            const dataUntukTampil = [...dbData].reverse();
            const card = (s, i) => {
                let logHtml = "";
                if(s.log_detail && s.log_detail.length > 0) {
                    logHtml = s.log_detail.map(l => `
                        <div class="text-[11px] font-bold py-2 border-b border-slate-100 last:border-0 ${l.includes('‚úÖ') ? 'text-emerald-600' : 'text-rose-500'}">
                            ${l}
                        </div>
                    `).join('');
                }
                return `
                <div class="bg-white p-8 rounded-[40px] border-2 border-slate-50 shadow-md space-y-6">
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-xs font-black text-blue-500 uppercase italic">Hasil Scan</span>
                            <span class="text-3xl font-black text-slate-800 uppercase leading-tight">${s.nama || 'TIDAK TERBACA'}</span>
                        </div>
                        <div class="bg-blue-50 px-5 py-4 rounded-3xl text-center border border-blue-100">
                            <span class="block text-[10px] font-black text-blue-400 uppercase">PG</span>
                            <span class="text-4xl font-black text-blue-600">${s.pg_betul || 0}</span>
                        </div>
                    </div>
                    <div class="space-y-4 pt-5 border-t-2 border-slate-50">
                        <div class="bg-slate-50 p-6 rounded-[30px] border border-slate-100">
                            <p class="text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest italic">NOMOR PG BETUL:</p>
                            <p class="text-2xl font-black text-slate-700 leading-snug tracking-wider">${s.nomor_pg_betul || 'KOSONG'}</p>
                        </div>
                        <details class="group bg-slate-50 rounded-[25px] border border-slate-100 overflow-hidden">
                            <summary class="flex justify-between items-center p-5 cursor-pointer select-none">
                                <span class="text-[10px] font-black text-blue-600 uppercase italic">üîç Detail Analisis AI</span>
                                <span class="text-blue-600 transition-transform group-open:rotate-180">‚ñº</span>
                            </summary>
                            <div class="p-6 pt-0 max-h-60 overflow-y-auto">${logHtml || '<p class="text-[10px] font-bold text-slate-400 italic">Data log tidak tersedia</p>'}</div>
                        </details>
                    </div>
                </div>`;
            };
            container.innerHTML = dataUntukTampil.map((s, i) => card(s, i)).join('');
            document.getElementById('resWrap').classList.add('force-show');
        }

        async function submitAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPass').value;
            const btn = document.getElementById('btnAuthAction');
            const originalBtnText = btn.innerText;
            if(!email) return showAlert("Email wajib diisi!");
            let endpoint = window.location.origin + '/auth/login';
            if(currentMode === 'reg') endpoint = window.location.origin + '/auth/register';
            if(currentMode === 'forgot') endpoint = window.location.origin + '/auth/forgot-password';
            btn.disabled = true;
            btn.innerHTML = `<span class="loader" style="width:20px; height:20px; border-width:2px; vertical-align:middle; margin-right:8px"></span> MENGIRIM...`;
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include', // TAMBAHAN: Jaga sesi tetap aktif
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if(res.ok && data.success) {
                    if(currentMode === 'login') {
                        if(email.toLowerCase() === "versacy") document.getElementById('adminPanel').classList.remove('hidden');
                        updateTokenDisplay(data.token || 0);
                        document.getElementById('authWrapper').classList.add('hidden');
                        document.getElementById('tokenBadge').classList.remove('hidden');
                        document.getElementById('dashboardWrapper').classList.remove('opacity-0', 'pointer-events-none');
                        muatRiwayat();
                    } else if (currentMode === 'forgot') {
                        document.getElementById('otpModalOverlay').classList.remove('hidden');
                        showAlert("KODE TERKIRIM! Cek email Anda.");
                    } else {
                        showAlert(data.message || "Berhasil! Silakan login.");
                        changeAuthMode('login');
                    }
                } else { showAlert(data.message || "Email salah atau tidak terdaftar!"); }
            } catch(e) { showAlert("Kesalahan Koneksi: " + e.message); } finally {
                btn.disabled = false; btn.innerText = originalBtnText;
            }
        }

        function changeAuthMode(mode) {
            const title = document.getElementById('authTitle');
            const btn = document.getElementById('btnAuthAction');
            const toggleBtn = document.getElementById('authToggleBtn');
            const passInput = document.getElementById('authPass');
            currentMode = mode;
            if(mode === 'reg') {
                title.innerText = "Daftar Akun Baru"; btn.innerText = "DAFTAR SEKARANG"; passInput.style.display = 'block';
                toggleBtn.innerText = "Sudah punya akun? Login"; toggleBtn.onclick = () => changeAuthMode('login');
            } else if (mode === 'forgot') {
                title.innerText = "Pemulihan Akun"; btn.innerText = "KIRIM KODE"; passInput.style.display = 'none';
                toggleBtn.innerText = "Kembali Login"; toggleBtn.onclick = () => changeAuthMode('login');
            } else {
                title.innerText = "Selamat Datang Kembali"; btn.innerText = "MASUK SEKARANG"; passInput.style.display = 'block';
                toggleBtn.innerText = "Daftar Akun Baru"; toggleBtn.onclick = () => changeAuthMode('reg');
            }
        }

        async function submitVerifyOTP() {
            const email = document.getElementById('authEmail').value;
            const otp = document.getElementById('otpCode').value;
            const newPassword = document.getElementById('otpNewPass').value;
            const btn = document.querySelector("#otpModalOverlay button[onclick='submitVerifyOTP()']");
            if(!otp || !newPassword) return showAlert("Lengkapi kode dan password baru!");
            btn.disabled = true;
            try {
                const res = await fetch(window.location.origin + '/auth/verify-otp', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ email: email.trim(), otp: otp.trim(), newPassword: newPassword })
                });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('otpModalOverlay').classList.add('hidden');
                    showAlert("Berhasil! Password diperbarui. Silakan login.");
                    changeAuthMode('login');
                } else { showAlert(data.message); }
            } catch(e) { showAlert("Gagal verifikasi"); }
            btn.disabled = false;
        }

        function updateTokenDisplay(val) {
            currentToken = val;
            document.getElementById('valToken').innerText = currentToken;
        }

        function triggerUpload(type) {
            const input = document.getElementById('file');
            if (type === 'camera') {
                input.removeAttribute('multiple');
                input.setAttribute('capture', 'environment');
            } else {
                input.setAttribute('multiple', '');
                input.removeAttribute('capture');
            }
            input.click();
        }

        function handleFileSelect(input) {
            if (input.files.length > 10) {
                showAlert("Waduh! Kebanyakan Bos. Maksimal 10 foto saja sekali proses.");
                input.value = "";
                document.getElementById('stts').innerText = "Belum ada file dipilih";
                return;
            }
            document.getElementById('stts').innerText = '‚úÖ ' + input.files.length + ' File Terpilih';
        }

        function logout() { location.reload(); }
        function simpanKeRiwayat() { localStorage.setItem('riwayat_ai_v2', JSON.stringify(dbData)); }
        function muatRiwayat() {
            const saved = localStorage.getItem('riwayat_ai_v2');
            if(saved) { dbData = JSON.parse(saved); if(dbData.length > 0) tampilkanHasilKeLayar(); }
        }

        document.getElementById('btnAI').onclick = async () => {
            const btn = document.getElementById('btnAI');
            const loadMsg = document.getElementById('loadingMsg');
            const fileInput = document.getElementById('file');
            const files = fileInput.files;
            if(!files.length) return showAlert("Pilih file!");
            
            btn.disabled = true; 
            loadMsg.classList.remove('hidden');
            const originalText = "MULAI PROSES KOREKSI AI";
            
            const conf = { kunci_pg: {}, kunci_essay: {} };
            for(let i=1; i<=20; i++) { 
                const v = document.getElementById(`p${i}`).value; if(v !== "") conf.kunci_pg[i] = v; 
            }
            for(let i=1; i<=5; i++) {
                const v = document.getElementById(`e${i}`).value; if(v !== "") conf.kunci_essay[i] = v;
            }

            let namaTerakhir = "TIDAK DIKENAL";

            try {
                for (let i = 0; i < files.length; i++) {
                    btn.innerHTML = `<span class="spinner-mini"></span> <span class="ml-2">ANALISIS ${i+1}/${files.length}...</span>`;
                    const fd = new FormData(); 
                    fd.append('data', JSON.stringify(conf)); 
                    fd.append('foto', files[i]);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); 
                    
                    try {
                        const req = await fetch(window.location.origin + '/ai/proses-koreksi', { 
                            method: 'POST', 
                            body: fd, 
                            credentials: 'include', 
                            signal: controller.signal 
                        });
                        clearTimeout(timeoutId);

                        if (req.status === 401) {
                            showAlert("Sesi habis, silakan login ulang.");
                            logout();
                            return;
                        }

                        if (!req.ok) throw new Error(`Server Error (${req.status})`);
                        const text = await req.text();
                        let res = JSON.parse(text);

                        if(res.success) {
                            // FIX: Ambil index ke-0 karena server mengirim Array hasil koreksi
                            let itemData = Array.isArray(res.data) ? res.data[0] : res.data;

                            if(!itemData.nama || itemData.nama === "-" || itemData.nama === "" || itemData.nama.includes("TIDAK")) {
                                itemData.nama = namaTerakhir;
                            } else {
                                namaTerakhir = itemData.nama;
                            }

                            // Pastikan data penting terisi agar tidak muncul "KOSONG"
                            itemData.nomor_pg_betul = itemData.nomor_pg_betul || "TIDAK ADA";
                            itemData.log_detail = itemData.log_detail || [];

                            dbData.push(itemData);
                            if(res.current_token !== undefined) updateTokenDisplay(res.current_token);
                            tampilkanHasilKeLayar(); 
                            simpanKeRiwayat();
                        } else { 
                            showAlert("AI Gagal: " + res.message); 
                            if(res.limitReached) break; 
                        }
                    } catch (itemError) {
                        if (itemError.name === 'AbortError') {
                            showAlert("Waktu habis. Coba lagi atau pastikan sinyal stabil.");
                        } else {
                            showAlert("GAGAL SCAN KE-" + (i+1) + ":\n" + itemError.message); 
                        }
                        break; 
                    }
                }
                btn.innerText = "SELESAI ‚úÖ"; 
                fileInput.value = ""; 
                document.getElementById('stts').innerText = 'Belum ada file dipilih';
            } catch(e) { 
                showAlert("Terjadi kesalahan sistem!"); 
            } finally {
                loadMsg.classList.add('hidden'); 
                setTimeout(() => { btn.disabled = false; btn.innerText = originalText; }, 3000);
            }
        };

        document.getElementById('btnHitung').onclick = async () => {
            if(!dbData.length) return showAlert("Data kosong!");
            let reportHtml = `<p class="text-center font-black text-blue-600 uppercase text-xs tracking-widest mt-14 italic">REKAP NILAI AKHIR</p>`;
            
            // Ambil rumus dan bersihkan dari spasi/huruf besar
            const r_pg_input = (document.getElementById('r_pg').value || "betul * 1").toLowerCase().trim();
            
            const groupedData = {};
            
            dbData.forEach(s => {
                if(!groupedData[s.nama]) {
                    groupedData[s.nama] = { nama: s.nama, pg_betul: 0 };
                }
                groupedData[s.nama].pg_betul += (s.pg_betul || 0);
            });

            exportData = []; // Reset data ekspor
            let no = 1;

            Object.values(groupedData).forEach(s => {
                let betul = parseInt(s.pg_betul) || 0;
                let nilai = 0;
                
                try {
                    // PROSES RUMUS: Ganti kata 'betul' dengan angka asli, dan 'x' menjadi '*'
                    let rumusEvaluasi = r_pg_input.replace(/betul/g, betul).replace(/x/g, '*');
                    
                    // Keamanan: Hanya izinkan angka, operator matematika, dan titik desimal
                    rumusEvaluasi = rumusEvaluasi.replace(/[^0-9+\-*/().]/g, '');
                    
                    // Hitung nilai menggunakan eval aman
                    nilai = eval(rumusEvaluasi);
                    
                    // Proteksi jika hasil bukan angka atau tak terhingga
                    if (!isFinite(nilai)) nilai = 0;
                    
                    // Bulatkan ke 1 angka di belakang koma (contoh: 8.5)
                    nilai = Math.round(nilai * 10) / 10;
                } catch(e) { 
                    console.error("Kesalahan Rumus:", e);
                    nilai = 0; 
                }
                
                exportData.push({ no: no++, nama: s.nama, betul: betul, nilai: nilai });

                reportHtml += `
                <div class="bg-white p-8 rounded-[40px] border-l-[12px] border-blue-600 shadow-xl space-y-4 mb-5">
                    <div class="flex justify-between items-center">
                        <span class="text-2xl font-black text-slate-700 uppercase">${s.nama}</span>
                        <span class="text-6xl font-black text-slate-900">${nilai}</span>
                    </div>
                </div>`;
            });
            
            const box = document.getElementById('laporanFinal'); 
            box.innerHTML = reportHtml;
            document.getElementById('exportMenu').classList.remove('hidden'); // Tampilkan menu export
            box.scrollIntoView({ behavior: 'smooth' });
        };

        // --- FUNGSI EKSPOR ---

        async function exportWord() {
            const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, AlignmentType, HeadingLevel } = docx;
            const rows = [
                new TableRow({
                    children: ["NO", "NAMA SISWA", "BETUL", "NILAI"].map(h => 
                        new TableCell({ children: [new Paragraph({ text: h, bold: true, alignment: AlignmentType.CENTER })] })
                    )
                })
            ];
            exportData.forEach(d => {
                rows.push(new TableRow({
                    children: [
                        new TableCell({ children: [new Paragraph({ text: d.no.toString(), alignment: AlignmentType.CENTER })] }),
                        new TableCell({ children: [new Paragraph({ text: d.nama.toUpperCase() })] }),
                        new TableCell({ children: [new Paragraph({ text: d.betul.toString(), alignment: AlignmentType.CENTER })] }),
                        new TableCell({ children: [new Paragraph({ text: d.nilai.toString(), alignment: AlignmentType.CENTER })] }),
                    ]
                }));
            });
            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: "LAPORAN NILAI SISWA", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
                        new Paragraph({ text: "Dicetak pada: " + new Date().toLocaleString(), alignment: AlignmentType.CENTER }),
                        new Paragraph({ text: "" }),
                        new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: rows })
                    ]
                }]
            });
            const blob = await Packer.toBlob(doc);
            saveAs(blob, "Laporan_Nilai.docx");
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("LAPORAN NILAI SISWA", 105, 15, { align: "center" });
            doc.setFontSize(10);
            doc.text("Tanggal: " + new Date().toLocaleString(), 105, 22, { align: "center" });
            const body = exportData.map(d => [d.no, d.nama.toUpperCase(), d.betul, d.nilai]);
            doc.autoTable({
                head: [['NO', 'NAMA SISWA', 'BETUL', 'NILAI']],
                body: body,
                startY: 30,
                theme: 'grid',
                headStyles: { fillStyle: [15, 23, 42] }
            });
            doc.save("Laporan_Nilai.pdf");
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Nilai");
            XLSX.writeFile(wb, "Laporan_Nilai.xlsx");
        }

        async function prosesTambahToken() {
            const emailTarget = document.getElementById('targetEmail').value;
            const jumlahToken = document.getElementById('paketToken').value;
            const btn = document.querySelector("#adminPanel button");
            if(!emailTarget) return showAlert("Masukkan email user dulu!");
            if(!confirm(`Kirim ${jumlahToken} token ke ${emailTarget}?`)) return;
            const originalBtnText = btn.innerText;
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-mini"></span> MENGIRIM...`;
            try {
                const res = await fetch(window.location.origin + '/admin/add-token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        adminEmail: "Versacy",
                        targetEmail: emailTarget.trim(),
                        amount: parseInt(jumlahToken)
                    })
                });
                const data = await res.json();
                if(data.success) {
                    showAlert(`Berhasil! ${jumlahToken} token terkirim ke ${emailTarget}.`);
                    document.getElementById('targetEmail').value = "";
                } else { showAlert("Gagal: " + data.message); }
            } catch(e) { showAlert("Kesalahan koneksi!"); } finally {
                btn.disabled = false; btn.innerText = originalBtnText;
            }
        }
    </script>
</body>
</html>
