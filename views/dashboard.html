<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Koreksi AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f1f5f9; font-family: sans-serif; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4 pb-10">
    <div class="max-w-md mx-auto space-y-4">
        
        <div class="flex justify-between items-center mb-4">
            <h1 class="font-black text-xl italic text-slate-800">JAWABAN <span class="text-blue-600">AI</span></h1>
            <button onclick="location.reload()" class="text-red-500 font-bold text-xs">KELUAR</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <label class="card flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-blue-200">
                <span class="text-2xl">üì∏</span>
                <span class="text-[10px] font-bold uppercase mt-1">Kamera</span>
                <input type="file" id="inpCam" capture="environment" class="hidden" onchange="listItems()">
            </label>
            <label class="card flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-blue-200">
                <span class="text-2xl">üìÅ</span>
                <span class="text-[10px] font-bold uppercase mt-1">File</span>
                <input type="file" id="inpFile" multiple class="hidden" onchange="listItems()">
            </label>
        </div>

        <div id="fileBox" class="hidden card bg-blue-50 border-blue-100">
            <h4 class="text-[9px] font-black text-blue-600 uppercase mb-2">Item Berhasil Diupload:</h4>
            <div id="fileList" class="space-y-1 text-[10px] font-mono text-slate-600"></div>
        </div>

        <div class="card">
            <h3 class="text-[10px] font-black uppercase text-blue-600 mb-3 tracking-widest">Kunci PG</h3>
            <div id="pgArea" class="grid grid-cols-5 gap-2"></div>
        </div>

        <div class="card">
            <h3 class="text-[10px] font-black uppercase text-emerald-600 mb-3 tracking-widest">Kunci Essay</h3>
            <div id="esArea" class="space-y-2"></div>
        </div>

        <button id="btnKoreksi" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl text-xs uppercase shadow-lg">Mulai Proses Koreksi AI</button>

        <div id="boxKoreksi" class="space-y-3"></div>

        <div id="boxRumus" class="hidden space-y-3 pt-6 border-t-2 border-dashed border-slate-300">
            <p class="text-center font-bold text-blue-600 text-[9px] italic">*Masukan rumus penilaian kamu*</p>
            <div class="card bg-slate-50 space-y-3 border-slate-200">
                <input type="text" id="rumus_pg" placeholder="Rumus PG (Contoh: betul * 2)" class="w-full p-3 rounded-xl border-none shadow-sm text-sm font-bold text-blue-600">
                <input type="text" id="rumus_es" placeholder="Rumus Essay (Contoh: betul * 10)" class="w-full p-3 rounded-xl border-none shadow-sm text-sm font-bold text-emerald-600">
                <button id="btnHitung" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl text-[10px] uppercase">Proses Hitung Rumus</button>
            </div>
        </div>

        <div id="boxHasil" class="space-y-3"></div>

    </div>

    <script>
        // Generate Input Kunci
        for(let i=1; i<=20; i++) document.getElementById('pgArea').innerHTML += `<select id="p${i}" class="p-2 border rounded-lg text-[10px] font-bold"><option value="">${i}</option><option>A</option><option>B</option><option>C</option></select>`;
        for(let i=1; i<=5; i++) document.getElementById('esArea').innerHTML += `<input type="text" id="e${i}" placeholder="Kunci Essay ${i}" class="w-full p-3 bg-slate-50 rounded-xl text-[11px] border-none outline-none font-bold">`;

        function listItems() {
            const box = document.getElementById('fileBox');
            const list = document.getElementById('fileList');
            const files = [...document.getElementById('inpCam').files, ...document.getElementById('inpFile').files];
            if(files.length > 0) {
                box.classList.remove('hidden');
                list.innerHTML = files.map((f, i) => `<div>‚úÖ Item ${i+1}: <b>${f.name}</b></div>`).join('');
            }
        }

        let databaseAI = [];

        document.getElementById('btnKoreksi').onclick = async () => {
            const btn = document.getElementById('btnKoreksi'); btn.innerText = "SEDANG MENGOREKSI...";
            const config = { kunci_pg: {}, kunci_essay: {} };
            for(let i=1; i<=20; i++) config.kunci_pg[i] = document.getElementById(`p${i}`).value;
            for(let i=1; i<=5; i++) config.kunci_essay[i] = document.getElementById(`e${i}`).value;

            const fd = new FormData();
            fd.append('data', JSON.stringify(config));
            const files = [...document.getElementById('inpCam').files, ...document.getElementById('inpFile').files];
            files.forEach(f => fd.append('foto', f));

            const res = await fetch('/ai/proses-koreksi', { method: 'POST', body: fd });
            const json = await res.json();
            if(json.success) {
                databaseAI = json.data;
                const container = document.getElementById('boxKoreksi');
                container.innerHTML = "";
                databaseAI.forEach(s => {
                    container.innerHTML += `<div class="card border-l-4 border-slate-900"><p class="text-xs font-bold uppercase">Nama: ${s.nama}</p><p class="text-[10px] text-slate-500">Betul PG: ${s.pg_betul} | Betul Essay: ${s.es_betul}</p></div>`;
                });
                document.getElementById('boxRumus').classList.remove('hidden');
            }
            btn.innerText = "Mulai Proses Koreksi AI";
        };

        document.getElementById('btnHitung').onclick = async () => {
            const res = await fetch('/ai/hitung-rumus', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ data: databaseAI, rumus_pg: document.getElementById('rumus_pg').value, rumus_es: document.getElementById('rumus_es').value })
            });
            const json = await res.json();
            if(json.success) {
                const box = document.getElementById('boxHasil');
                box.innerHTML = `<h2 class="text-center font-black text-[10px] text-blue-600 uppercase mt-6 mb-3">Laporan Hasil Rumus</h2>`;
                json.hasil.forEach(s => {
                    box.innerHTML += `<div class="card border-l-4 border-blue-600"><p class="text-xs font-bold uppercase">"Nama: ${s.nama}"</p><p class="text-2xl font-black mt-2 text-slate-900">Nilai: ${s.nilai_akhir}"</p></div>`;
                });
            }
        };
    </script>
</body>
</html>
