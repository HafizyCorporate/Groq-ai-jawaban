<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Jawaban AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus_Jakarta_Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* STYLE SAMA SEPERTI ASLINYA */
        html { font-size: 18px; } 
        body { font-size: 1rem; font-family: 'Plus_Jakarta_Sans', sans-serif; background-color: #f1f5f9; }
        .force-show { display: block !important; opacity: 1 !important; visibility: visible !important; }
        .spinner-mini { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s ease-in-out infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-animate { animation: modalBounce 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalBounce { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .notice-red { background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); border-left: 6px solid #e53e3e; }
        
        /* RESPONSIVE */
        @media (max-width: 767px) { html { font-size: 15px; } body { padding: 12px; } .rounded-\[45px\], .rounded-\[40px\] { border-radius: 28px !important; } .rounded-\[35px\], .rounded-\[30px\] { border-radius: 20px !important; } .p-10 { padding: 1.5rem !important; } .p-8 { padding: 1.2rem !important; } .py-8 { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; } .text-5xl { font-size: 2.5rem !important; } .text-3xl { font-size: 1.75rem !important; } #gridPG { gap: 8px !important; } select.key-dropdown { font-size: 1.1rem !important; padding: 0.8rem 0.4rem !important; } }
        @media (min-width: 1024px) { #dashboardWrapper { max-width: 1200px !important; display: grid; grid-template-columns: 480px 1fr; gap: 2rem; align-items: start; } .header-area, #adminPanel, .upload-section, .notice-area { grid-column: span 2; } #resWrap { margin-top: 0 !important; padding-top: 0 !important; } }
        @media (min-width: 768px) { #dashboardWrapper { max-width: 650px; margin: 2rem auto !important; } }

        select.key-dropdown { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.2em; font-size: 1.4rem !important; padding: 1rem !important; }
        details summary::-webkit-details-marker { display:none; } details summary { list-style: none; }
        
        /* CUSTOM: NOMOR PG AGAK BESAR & BOLD */
        .nomor-pg { font-size: 14px !important; font-weight: 800 !important; color: #64748b !important; }
    </style>
</head>
<body class="bg-slate-50 p-4 text-slate-900">

    <div id="customAlertOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-sm rounded-[40px] p-8 shadow-2xl modal-animate text-center border border-slate-100">
            <div id="alertIcon" class="text-7xl mb-4">‚ö†Ô∏è</div>
            <h3 id="alertTitle" class="text-2xl font-black uppercase text-slate-800 mb-2">Pemberitahuan</h3>
            <p id="alertMsg" class="text-lg font-bold text-slate-500 leading-relaxed mb-8 whitespace-pre-line"></p>
            <div id="alertButtons" class="space-y-3">
                <button onclick="closeAlert()" class="w-full bg-blue-600 text-white font-black py-6 rounded-[25px] text-sm uppercase">Oke</button>
            </div>
        </div>
    </div>

    <div id="topupModalOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[220] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[40px] p-8 shadow-2xl modal-animate border border-slate-100 overflow-y-auto max-h-[90vh]">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üí≥</div>
                <h3 class="text-2xl font-black uppercase text-slate-800">Topup Token</h3>
                <p class="text-slate-500 font-bold text-sm">Pilih paket dan bayar otomatis via Saweria</p>
            </div>
            <div class="notice-red p-4 rounded-2xl border border-red-200 mb-6">
                <p class="text-[11px] font-black text-red-600 uppercase mb-1">‚ö†Ô∏è PENTING:</p>
                <p class="text-[12px] font-bold text-slate-600 leading-tight">
                    Saat di halaman Saweria, Anda <b>WAJIB</b> menuliskan <b>ALAMAT EMAIL</b> Anda di kolom "Pesan" agar token masuk otomatis.
                </p>
            </div>
            <div class="space-y-3">
                <button onclick="bayarSaweria('p5k')" class="w-full flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100 hover:border-blue-400 transition"><span class="font-black text-slate-700 uppercase text-xs">10 Token</span><span class="font-black text-blue-600">Rp 5.000</span></button>
                <button onclick="bayarSaweria('p10k')" class="w-full flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100 hover:border-blue-400 transition"><span class="font-black text-slate-700 uppercase text-xs">22 Token</span><span class="font-black text-blue-600">Rp 10.000</span></button>
                <button onclick="bayarSaweria('p20k')" class="w-full flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100 hover:border-blue-400 transition"><span class="font-black text-slate-700 uppercase text-xs">45 Token</span><span class="font-black text-blue-600">Rp 20.000</span></button>
                <button onclick="bayarSaweria('p50k')" class="w-full flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100 hover:border-blue-400 transition"><span class="font-black text-slate-700 uppercase text-xs">120 Token</span><span class="font-black text-blue-600">Rp 50.000</span></button>
                <button onclick="bayarSaweria('p100k')" class="w-full flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100 hover:border-blue-400 transition"><span class="font-black text-slate-700 uppercase text-xs">280 Token</span><span class="font-black text-blue-600">Rp 100.000</span></button>
            </div>
            <button onclick="document.getElementById('topupModalOverlay').classList.add('hidden')" class="w-full mt-6 text-slate-400 font-black py-2 text-xs uppercase">Batal</button>
        </div>
    </div>

    <div id="tokenBadge" class="fixed top-4 right-4 z-[110] flex flex-col items-end gap-2">
        <div class="bg-white/90 backdrop-blur-md border border-blue-100 px-6 py-4 rounded-full shadow-xl flex items-center gap-3">
            <span class="text-xs font-black text-slate-400 uppercase italic">Token:</span>
            <span id="valToken" class="text-3xl font-black text-blue-600">...</span>
        </div>
        <button onclick="openTopupModal()" class="bg-orange-500 text-white px-4 py-2 rounded-full text-[10px] font-black uppercase shadow-lg animate-bounce">
            + ISI TOKEN
        </button>
    </div>

    <div id="dashboardWrapper" class="max-w-md mx-auto space-y-6">
        <div class="header-area flex justify-between items-center py-6">
            <h1 class="text-3xl font-black italic uppercase">JAWABAN <span class="text-blue-600">AI</span></h1>
            <button onclick="logout()" class="bg-red-50 text-red-500 px-6 py-3 rounded-full text-xs font-black uppercase">Keluar</button>
        </div>

        <div id="adminPanel" class="hidden bg-slate-900 p-8 rounded-[40px] border-2 border-blue-500 shadow-xl mb-6">
            <p class="text-xs font-black text-blue-400 uppercase mb-4 tracking-widest text-center italic">üíé Admin Dashboard</p>
            <div class="space-y-4">
                <input type="email" id="targetEmail" placeholder="Email User" class="w-full p-5 bg-slate-800 text-white rounded-2xl text-lg font-bold border border-slate-700">
                <select id="paketToken" class="w-full p-5 bg-slate-800 text-white rounded-2xl text-lg font-bold border border-slate-700">
                    <option value="100">100 Token</option>
                    <option value="210">210 Token</option>
                    <option value="350">350 Token</option>
                </select>
                <button onclick="prosesTambahToken()" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl text-xs uppercase">Tambah Token</button>
            </div>
        </div>

        <div class="notice-area notice-red p-6 rounded-[30px] shadow-sm border border-red-200">
            <p class="text-[13px] font-bold text-slate-600 leading-relaxed mb-1">
                Tolong upload foto siswa **sesuai urutan**. Jika soal ada 2 lembar, pastikan foto lembar yang ada namanya dipilih **lebih dulu**.
            </p>
            <p class="text-[14px] font-black text-red-700 uppercase tracking-tighter bg-red-100 inline-block px-2 py-1 rounded-lg border border-red-300">
                üöÄ MAX 10 FOTO PER SESI
            </p>
        </div>

        <div class="upload-section grid grid-cols-2 gap-4">
            <button onclick="triggerUpload('camera')" class="bg-white p-10 rounded-[35px] border-2 border-dashed border-slate-200 flex flex-col items-center hover:bg-slate-50 active:scale-95 transition">
                <span class="text-5xl mb-2">üì∏</span><span class="text-xs font-black uppercase text-slate-500">Ambil Foto</span>
            </button>
            <button onclick="triggerUpload('gallery')" class="bg-white p-10 rounded-[35px] border-2 border-dashed border-slate-200 flex flex-col items-center hover:bg-slate-50 active:scale-95 transition">
                <span class="text-5xl mb-2">üñºÔ∏è</span><span class="text-xs font-black uppercase text-slate-500">Pilih Galeri</span>
            </button>
            <input type="file" id="file" multiple class="hidden" onchange="handleFileSelect(this)" accept="image/*">
            <div id="stts" class="col-span-2 text-xs font-black text-blue-600 uppercase text-center italic">Belum ada file dipilih</div>
        </div>

        <div class="left-col space-y-6">
            <div class="bg-white p-8 rounded-[45px] shadow-sm border border-slate-100">
                <p class="text-xs font-black text-blue-600 uppercase mb-6 tracking-widest">Kunci PG (1-40)</p>
                <div id="gridPG" class="grid grid-cols-4 sm:grid-cols-5 gap-y-6 gap-x-3 mb-10"></div>
                <p class="text-xs font-black text-emerald-500 uppercase mb-5 tracking-widest">Kunci Essay (1-20)</p>
                <div id="gridES" class="space-y-4"></div>
            </div>
            <button id="btnAI" class="w-full bg-[#0f172a] text-white font-black py-8 rounded-[40px] text-lg uppercase shadow-xl transition active:scale-95">MULAI PROSES KOREKSI AI</button>
            <p id="loadingMsg" class="hidden text-center text-xs font-black text-blue-500 italic mt-2 animate-pulse">ü§ñ Gemini sedang menganalisis gambar...</p>
        </div>

        <div id="resWrap" class="hidden space-y-6 pt-10">
            <div class="flex justify-between items-center px-2">
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest italic">Hasil Scan Terbaru</p>
                <button onclick="konfirmasiHapusRiwayat()" class="text-xs font-black text-red-500 uppercase">Bersihkan</button>
            </div>
            <div id="scanAwal" class="space-y-6"></div>
            <div class="bg-white p-10 rounded-[45px] border-t-[6px] border-blue-600 space-y-6 shadow-xl mt-14">
                <div class="notice-red p-6 rounded-[25px] border border-red-200">
                    <div class="flex items-center gap-3 mb-2"><span class="text-2xl">‚ö†Ô∏è</span><p class="text-xs font-black text-red-600 uppercase tracking-widest italic leading-none">PENTING: PETUNJUK GURU</p></div>
                    <p class="text-[13px] font-bold text-red-500 leading-relaxed">Halo guru biarkan sampai guru selesai menginput nilai siswa ya baru Guru hitung rumusnya dibawah ini agar nanti laporan cetaknya semua masuk. Jangan lupa tulis mata pelajarannya agar laporan terpisah dengan mata pelajaran lain. Terimakasih</p>
                </div>
                <p class="text-center font-black text-blue-600 text-xs uppercase italic">Pengaturan Laporan & Nilai</p>
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 italic">Mata Pelajaran:</p>
                    <input type="text" id="mapel" placeholder="Contoh: Matematika" class="w-full p-5 bg-slate-50 rounded-2xl text-sm font-bold border border-slate-100 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-2 ml-1 italic">Rumus PG:</p>
                        <input type="text" id="r_pg" placeholder="betul * 1" class="w-full p-5 bg-slate-50 rounded-2xl text-sm font-bold border border-slate-100 outline-none">
                    </div>
                    <div>
                        <p class="text-[10px] font-black text-emerald-500 uppercase mb-2 ml-1 italic">Rumus Essay:</p>
                        <input type="text" id="r_es" placeholder="betul * 10" class="w-full p-5 bg-slate-50 rounded-2xl text-sm font-bold border border-slate-100 outline-none">
                    </div>
                </div>
                <button id="btnHitung" class="w-full bg-blue-600 text-white font-black py-7 rounded-[30px] text-sm uppercase shadow-lg">HITUNG NILAI AKHIR</button>
            </div>
            <div id="exportMenu" class="hidden grid grid-cols-3 gap-2 px-2">
                <button onclick="exportWord()" class="bg-blue-100 text-blue-700 py-4 rounded-2xl text-[10px] font-black uppercase border border-blue-200">DOCX</button>
                <button onclick="exportPDF()" class="bg-red-100 text-red-700 py-4 rounded-2xl text-[10px] font-black uppercase border border-red-200">PDF</button>
                <button onclick="exportExcel()" class="bg-emerald-100 text-emerald-700 py-4 rounded-2xl text-[10px] font-black uppercase border border-emerald-200">EXCEL</button>
            </div>
            <div id="laporanFinal" class="space-y-6 pb-40"></div>
        </div>
    </div>

    <script>
        // CEK STATUS LOGIN SAAT LOAD
        let userEmail = "";
        let dbData = [];
        let exportData = [];

        window.onload = function() {
            userEmail = localStorage.getItem('jawaban_ai_email');
            const token = localStorage.getItem('jawaban_ai_token');
            
            if(!userEmail) {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('valToken').innerText = token || 0;
            if(userEmail.toLowerCase() === "versacy") document.getElementById('adminPanel').classList.remove('hidden');
            
            muatRiwayat();
        };

        function logout() {
            if(confirm("Keluar dan hapus semua riwayat di sesi ini?")) {
                localStorage.removeItem('jawaban_ai_email');
                localStorage.removeItem('jawaban_ai_token');
                localStorage.removeItem('riwayat_ai_v2');
                window.location.href = 'login.html';
            }
        }

        // FUNGSI UMUM
        function showAlert(msg, mode = 'alert') {
            const overlay = document.getElementById('customAlertOverlay');
            const msgEl = document.getElementById('alertMsg');
            const titleEl = document.getElementById('alertTitle');
            const iconEl = document.getElementById('alertIcon');
            const btnArea = document.getElementById('alertButtons');
            msgEl.innerText = msg;
            btnArea.innerHTML = '';

            if (mode === 'confirm') {
                titleEl.innerText = "Konfirmasi"; iconEl.innerText = "üóëÔ∏è";
                btnArea.innerHTML = `
                    <button onclick="hapusRiwayat()" class="w-full bg-red-500 text-white font-black py-6 rounded-[25px] text-sm uppercase">Ya, Hapus Semua</button>
                    <button onclick="closeAlert()" class="w-full bg-slate-100 text-slate-500 font-black py-5 rounded-[25px] text-xs uppercase">Batal</button>`;
            } else if (msg.toLowerCase().includes("habis")) {
                titleEl.innerText = "Token Habis!"; iconEl.innerText = "üé´";
                btnArea.innerHTML = `
                    <button onclick="openTopupModal()" class="block w-full bg-blue-600 text-white font-black py-6 rounded-[25px] text-sm text-center uppercase">Topup Sekarang</button>
                    <button onclick="closeAlert()" class="w-full bg-slate-100 text-slate-500 font-black py-5 rounded-[25px] text-xs uppercase">Tutup</button>`;
            } else {
                titleEl.innerText = msg.includes("Berhasil") ? "Sukses!" : "Pemberitahuan";
                iconEl.innerText = msg.includes("Berhasil") ? "‚úÖ" : "‚ö†Ô∏è";
                btnArea.innerHTML = `<button onclick="closeAlert()" class="w-full bg-blue-600 text-white font-black py-6 rounded-[25px] text-sm uppercase">Oke</button>`;
            }
            overlay.classList.remove('hidden');
        }

        function closeAlert() { document.getElementById('customAlertOverlay').classList.add('hidden'); }
        function konfirmasiHapusRiwayat() { showAlert("Bersihkan semua laporan?", 'confirm'); }
        function hapusRiwayat() { dbData = []; localStorage.removeItem('riwayat_ai_v2'); location.reload(); }
        
        function openTopupModal() { document.getElementById('topupModalOverlay').classList.remove('hidden'); }
        
        function updateTokenDisplay(val) {
            document.getElementById('valToken').innerText = val;
            localStorage.setItem('jawaban_ai_token', val);
        }

        // INIT GRID KUNCI JAWABAN - PERUBAHAN: PG 40, ESSAY 20
        const gPG = document.getElementById('gridPG'); gPG.innerHTML = ''; 
        for(let i=1; i<=40; i++) {
            gPG.innerHTML += `<div class="flex flex-col items-center gap-2"><span class="nomor-pg uppercase italic leading-none">${i}</span><select id="p${i}" class="key-dropdown w-full p-4 bg-slate-50 rounded-xl text-2xl font-black border border-slate-100 outline-none text-center"><option value="">-</option><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option></select></div>`;
        }
        const gES = document.getElementById('gridES'); gES.innerHTML = '';
        for(let i=1; i<=20; i++) {
            gES.innerHTML += `<div class="relative"><span class="absolute left-5 top-1/2 -translate-y-1/2 text-xs font-black text-slate-300 italic uppercase">No ${i}</span><input id="e${i}" placeholder="Kunci Jawaban Essay..." class="w-full pl-20 p-5 bg-slate-50 rounded-2xl text-lg font-bold border border-slate-100 outline-none"></div>`;
        }

        // UPLOAD & AI LOGIC
        function triggerUpload(type) {
            const input = document.getElementById('file');
            if (type === 'camera') { input.removeAttribute('multiple'); input.setAttribute('capture', 'environment'); } else { input.setAttribute('multiple', ''); input.removeAttribute('capture'); }
            input.click();
        }
        function handleFileSelect(input) {
            if (input.files.length > 10) { showAlert("Waduh! Kebanyakan Bos. Maksimal 10 foto saja sekali proses."); input.value = ""; return; }
            document.getElementById('stts').innerText = '‚úÖ ' + input.files.length + ' File Terpilih';
        }

        document.getElementById('btnAI').onclick = async () => {
            const btn = document.getElementById('btnAI');
            const fileInput = document.getElementById('file');
            const files = fileInput.files;
            if(!files.length) return showAlert("Pilih file!");
            
            btn.disabled = true; document.getElementById('loadingMsg').classList.remove('hidden');
            const originalText = "MULAI PROSES KOREKSI AI";
            const conf = { kunci_pg: {}, kunci_essay: {} };
            for(let i=1; i<=40; i++) { const v = document.getElementById(`p${i}`).value; if(v !== "") conf.kunci_pg[i] = v; }
            for(let i=1; i<=20; i++) { const v = document.getElementById(`e${i}`).value; if(v !== "") conf.kunci_essay[i] = v; }

            let namaTerakhir = "TIDAK DIKENAL";
            try {
                for (let i = 0; i < files.length; i++) {
                    btn.innerHTML = `<span class="spinner-mini"></span> <span class="ml-2">ANALISIS ${i+1}/${files.length}...</span>`;
                    const fd = new FormData(); fd.append('data', JSON.stringify(conf)); fd.append('foto', files[i]);
                    const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 60000); 
                    try {
                        const req = await fetch(window.location.origin + '/ai/proses-koreksi', { method: 'POST', body: fd, credentials: 'include', signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (req.status === 401) { showAlert("Sesi habis, silakan login ulang."); logout(); return; }
                        const res = await req.json();
                        if(res.success) {
                            let itemData = Array.isArray(res.data) ? res.data[0] : res.data;
                            if(!itemData.nama || itemData.nama.includes("TIDAK")) itemData.nama = namaTerakhir; else namaTerakhir = itemData.nama;
                            dbData.push(itemData);
                            if(res.current_token !== undefined) updateTokenDisplay(res.current_token);
                            tampilkanHasilKeLayar(); simpanKeRiwayat();
                        } else { showAlert("AI Gagal: " + res.message); if(res.limitReached) break; }
                    } catch (e) { showAlert("GAGAL SCAN: " + e.message); break; }
                }
                btn.innerText = "SELESAI ‚úÖ"; fileInput.value = ""; document.getElementById('stts').innerText = 'Belum ada file dipilih';
            } catch(e) { showAlert("Terjadi kesalahan sistem!"); } finally {
                document.getElementById('loadingMsg').classList.add('hidden'); setTimeout(() => { btn.disabled = false; btn.innerText = originalText; }, 3000);
            }
        };

        function tampilkanHasilKeLayar() {
            const container = document.getElementById('scanAwal');
            if(!dbData.length) { container.innerHTML = ''; document.getElementById('resWrap').classList.add('hidden'); return; }
            const card = (s) => `
                <div class="bg-white overflow-hidden rounded-[40px] border border-slate-200 shadow-sm hover:shadow-md transition-all duration-300">
                    <div class="p-8 space-y-6">
                        <div class="flex justify-between items-center">
                            <div class="flex flex-col max-w-[70%]"><span class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-1">DATA SISWA TERDETEKSI</span><h2 class="text-2xl font-black text-slate-800 uppercase truncate">${s.nama || 'NAMA TIDAK JELAS'}</h2></div>
                            <div class="flex flex-col items-center justify-center bg-blue-600 text-white min-w-[70px] h-[70px] rounded-3xl shadow-lg shadow-blue-200"><span class="text-[9px] font-black uppercase opacity-80 leading-none mb-1">BETUL</span><span class="text-3xl font-black">${s.pg_betul || 0}</span></div>
                        </div>
                        <div class="bg-slate-50 rounded-[30px] p-6 border border-slate-100">
                            <div class="flex items-center gap-2 mb-3"><span class="text-lg">üìç</span><span class="text-[11px] font-black text-slate-400 uppercase tracking-widest italic">Pemetaan Jawaban Betul:</span></div>
                            <p class="text-xl font-black text-slate-700 tracking-widest leading-relaxed">${s.nomor_pg_betul || 'Kosong'}</p>
                        </div>
                    </div>
                </div>`;
            container.innerHTML = [...dbData].reverse().map(card).join('');
            document.getElementById('resWrap').classList.remove('hidden'); document.getElementById('resWrap').classList.add('force-show');
        }
        function simpanKeRiwayat() { localStorage.setItem('riwayat_ai_v2', JSON.stringify(dbData)); }
        function muatRiwayat() { const saved = localStorage.getItem('riwayat_ai_v2'); if(saved) { dbData = JSON.parse(saved); if(dbData.length) tampilkanHasilKeLayar(); } }

        // HITUNG & EXPORT
        document.getElementById('btnHitung').onclick = () => {
            if(!dbData.length) return showAlert("Data kosong!");
            let reportHtml = `<p class="text-center font-black text-blue-600 uppercase text-xs tracking-widest mt-14 italic">REKAP NILAI AKHIR</p>`;
            const r_pg = (document.getElementById('r_pg').value || "betul * 1").toLowerCase();
            const mapel = document.getElementById('mapel').value || "Tidak Disebutkan";
            const grouped = {}; dbData.forEach(s => { if(!grouped[s.nama]) grouped[s.nama] = {nama:s.nama, pg:0}; grouped[s.nama].pg += (s.pg_betul||0); });
            exportData = []; let no = 1;
            Object.values(grouped).forEach(s => {
                let nilai = 0; try { nilai = eval(r_pg.replace(/betul/g, s.pg).replace(/x/g, '*')); } catch(e){}
                exportData.push({no:no++, nama:s.nama, mapel, betul:s.pg, nilai});
                reportHtml += `<div class="bg-white p-8 rounded-[40px] border-l-[12px] border-blue-600 shadow-xl space-y-4 mb-5"><div class="flex justify-between items-start"><div class="flex flex-col"><span class="text-[10px] font-black text-slate-400 uppercase italic mb-1">${mapel}</span><span class="text-2xl font-black text-slate-700 uppercase">${s.nama}</span></div><span class="text-6xl font-black text-slate-900">${nilai}</span></div></div>`;
            });
            document.getElementById('laporanFinal').innerHTML = reportHtml; document.getElementById('exportMenu').classList.remove('hidden');
        };

        async function exportWord() { const {Document, Packer, Paragraph, Table, TableRow, TableCell} = docx; const blob = await Packer.toBlob(new Document({ sections: [{ children: [new Paragraph("LAPORAN NILAI"), new Table({ rows: [new TableRow({ children: ["NO","NAMA","MAPEL","BETUL","NILAI"].map(t=>new TableCell({children:[new Paragraph(t)]})) }), ...exportData.map(d => new TableRow({ children: [d.no,d.nama,d.mapel,d.betul,d.nilai].map(t=>new TableCell({children:[new Paragraph(t.toString())]})) })) ] })] }] })); saveAs(blob, `Nilai.docx`); }
        function exportPDF() { const doc = new window.jspdf.jsPDF(); doc.autoTable({ head: [['NO','NAMA','MAPEL','BETUL','NILAI']], body: exportData.map(d=>[d.no,d.nama,d.mapel,d.betul,d.nilai]) }); doc.save(`Nilai.pdf`); }
        function exportExcel() { const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData), "Nilai"); XLSX.writeFile(wb, `Nilai.xlsx`); }

        // TOPUP SAWERIA
        function bayarSaweria(p) {
            const nominal = {p5k:5000, p10k:10000, p20k:20000, p50k:50000, p100k:100000}[p];
            navigator.clipboard.writeText(userEmail).then(() => showAlert(`‚úÖ EMAIL DISALIN: ${userEmail}\nPaste di kolom PESAN Saweria agar token masuk!`)).catch(()=>{});
            setTimeout(() => { window.open(`https://saweria.co/GuruBantuGuru?amount=${nominal}`, '_blank'); document.getElementById('topupModalOverlay').classList.add('hidden'); }, 3000);
        }

        // ADMIN
        async function prosesTambahToken() {
            const tEmail = document.getElementById('targetEmail').value; const jml = document.getElementById('paketToken').value;
            if(!tEmail || !confirm(`Kirim ${jml} ke ${tEmail}?`)) return;
            try { await fetch(window.location.origin + '/admin/add-token', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({adminEmail:"Versacy", targetEmail:tEmail, amount:parseInt(jml)}) }); showAlert("Berhasil!"); } catch(e){ showAlert("Gagal!"); }
        }
    </script>
</body>
</html>
