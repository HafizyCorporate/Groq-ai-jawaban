<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard AutoSoal AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background: #050505; color: white; font-family: sans-serif; }
        .glass { background: rgba(20, 20, 20, 0.8); border: 1px solid #222; backdrop-filter: blur(10px); }
        select { background: #111; color: #3b82f6; border: 1px solid #333; padding: 4px; border-radius: 6px; font-weight: bold; outline: none; }
        textarea::placeholder { color: #444; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <nav class="p-4 glass flex justify-between items-center sticky top-0 z-50 border-b border-gray-800">
        <h1 class="text-xl font-black text-blue-500 tracking-tighter">AutoSoal AI</h1>
        <div class="flex items-center gap-4">
            <span id="userDisp" class="text-[10px] text-gray-500 font-bold uppercase"></span>
            <a href="/auth/logout" class="text-red-500 text-xs font-bold border border-red-500/30 px-4 py-1 rounded-full hover:bg-red-500 hover:text-white transition">LOGOUT</a>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-6 space-y-8">
        <form id="koreksiForm" class="space-y-6">
            <div class="glass p-6 rounded-3xl">
                <h3 class="text-blue-500 font-black mb-4 flex items-center gap-2 uppercase text-sm tracking-widest">Kunci Jawaban PG (1-20)</h3>
                <div id="pgGrid" class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    </div>
            </div>

            <div class="glass p-6 rounded-3xl">
                <h3 class="text-green-500 font-black mb-4 uppercase text-sm tracking-widest">Kriteria Jawaban Essay (1-10)</h3>
                <div id="essayList" class="space-y-3">
                    </div>
            </div>

            <div class="glass p-6 rounded-3xl space-y-6">
                <div class="bg-blue-900/10 p-4 rounded-2xl border border-blue-500/20">
                    <label class="text-[10px] text-blue-400 font-black uppercase block mb-2">Rumus Penilaian Akhir</label>
                    <input type="text" name="rumus_nilai" class="w-full bg-transparent text-xl font-mono text-white outline-none" value="(PG+Essay)/13*100">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <label class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-gray-800 rounded-3xl cursor-pointer hover:border-blue-500 transition group">
                        <span class="text-3xl mb-2 group-hover:scale-110 transition">üìÅ</span>
                        <span class="text-[10px] font-black text-gray-500 uppercase">File Galeri</span>
                        <input type="file" name="foto_tugas" multiple accept="image/*" class="hidden" id="fInp">
                    </label>
                    <label class="flex flex-col items-center justify-center p-8 border-2 border-dashed border-gray-800 rounded-3xl cursor-pointer hover:border-blue-500 transition group">
                        <span class="text-3xl mb-2 group-hover:scale-110 transition">üì∏</span>
                        <span class="text-[10px] font-black text-gray-500 uppercase">Ambil Kamera</span>
                        <input type="file" name="foto_tugas" capture="environment" accept="image/*" class="hidden" id="cInp">
                    </label>
                </div>
                <p id="stts" class="text-center text-[10px] text-gray-600 font-bold italic"></p>

                <button type="submit" id="btnGo" class="w-full bg-blue-600 p-5 rounded-2xl font-black text-white hover:bg-blue-500 shadow-2xl shadow-blue-900/40 transition transform active:scale-95">MULAI KOREKSI OTOMATIS</button>
            </div>
        </form>

        <div id="resSection" class="hidden space-y-6 animate-pulse-once">
            <div class="flex justify-between items-center border-b border-gray-800 pb-4">
                <h2 class="text-xl font-black text-white uppercase tracking-tighter">Hasil Analisis AI</h2>
                <button onclick="exportWord()" class="bg-white text-black text-[10px] font-black px-5 py-2 rounded-full uppercase hover:invert transition">Export to Word</button>
            </div>
            <div id="resList" class="space-y-4"></div>
        </div>
    </main>

    <script>
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        document.getElementById('userDisp').innerText = userData.username || 'User';

        // Buat Dropdown PG
        const pgGrid = document.getElementById('pgGrid');
        for(let i=1; i<=20; i++) {
            pgGrid.innerHTML += `
                <div class="flex items-center justify-between bg-black/50 p-2 rounded-xl border border-gray-900">
                    <span class="text-[10px] font-bold text-gray-600">${i}</span>
                    <select name="pg_${i}">
                        <option value="A">A</option><option value="B">B</option>
                        <option value="C">C</option><option value="D">D</option>
                    </select>
                </div>`;
        }

        // Buat Kolom Essay (Ketik Sendiri)
        const essayList = document.getElementById('essayList');
        for(let i=1; i<=10; i++) {
            essayList.innerHTML += `
                <div class="flex gap-3 items-start">
                    <span class="text-[10px] font-bold text-gray-600 mt-3">${i}.</span>
                    <textarea name="essay_${i}" placeholder="Ketik kunci jawaban/inti soal nomor ${i}..." 
                    class="w-full p-3 bg-black/50 border border-gray-900 rounded-xl text-xs outline-none focus:border-green-500 transition" rows="2"></textarea>
                </div>`;
        }

        document.getElementById('fInp').onchange = e => document.getElementById('stts').innerText = e.target.files.length + " Gambar Siap";
        document.getElementById('cInp').onchange = e => document.getElementById('stts').innerText = "Foto Kamera Siap";

        let dataGlobal = [];

        document.getElementById('koreksiForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnGo');
            btn.innerText = "MENGECEK TANDA X & ESSAY...";
            btn.disabled = true;

            const formData = new FormData(e.target);
            try {
                const res = await fetch('/ai/proses-koreksi', { method: 'POST', body: formData });
                const json = await res.json();
                
                if(json.success) {
                    dataGlobal = json.data;
                    document.getElementById('resSection').classList.remove('hidden');
                    let h = '';
                    dataGlobal.forEach(s => {
                        h += `
                        <div class="glass p-6 rounded-3xl border-l-4 border-blue-500">
                            <p class="text-lg font-black uppercase mb-2">Nama : ${s.nama}</p>
                            <div class="text-sm font-bold text-gray-400 space-y-1">
                                <p>Pg betul : ${s.pg_betul} salah : ${s.pg_salah}</p>
                                <p>Essay betul : ${s.essay_betul} salah : ${s.essay_salah}</p>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-800 flex justify-between items-end">
                                <div><p class="text-[8px] text-gray-600 font-black uppercase">Skor Akhir</p><p class="text-4xl font-black text-blue-500">${s.nilai_akhir}</p></div>
                                <span class="text-[9px] bg-blue-500/10 text-blue-500 px-3 py-1 rounded-full font-bold">TERVERIFIKASI AI</span>
                            </div>
                        </div>`;
                    });
                    document.getElementById('resList').innerHTML = h;
                    window.scrollTo({ top: document.getElementById('resSection').offsetTop - 100, behavior: 'smooth' });
                }
            } catch (err) { alert("Server Sibuk / API Error."); }
            btn.innerText = "MULAI KOREKSI OTOMATIS";
            btn.disabled = false;
        };

        function exportWord() {
            const { Document, Packer, Paragraph, TextRun } = docx;
            const content = dataGlobal.map(s => new Paragraph({
                children: [
                    new TextRun({ text: `Nama : ${s.nama}`, bold: true, size: 28 }),
                    new TextRun({ text: `\nPg betul : ${s.pg_betul} salah : ${s.pg_salah}`, size: 24 }),
                    new TextRun({ text: `\nEssay betul : ${s.essay_betul} salah : ${s.essay_salah}`, size: 24 }),
                    new TextRun({ text: `\nSkor Akhir: ${s.nilai_akhir}\n\n`, bold: true, size: 24 }),
                ],
            }));
            const doc = new Document({ sections: [{ children: content }] });
            Packer.toBlob(doc).then(b => saveAs(b, "Hasil_Koreksi.docx"));
        }
    </script>
</body>
</html>
