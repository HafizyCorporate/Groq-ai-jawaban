<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Akun - Te Az Ha AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #000; }
        .glass { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(31, 41, 55, 1); }
        .otp-input { letter-spacing: 0.5rem; text-align: center; font-size: 2rem !important; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="regBox" class="glass w-full max-w-md p-8 rounded-3xl shadow-2xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-blue-500 tracking-tighter">DAFTAR <span class="text-white">AKUN</span></h1>
            <p class="text-gray-400 text-sm mt-2">1 HP Maksimal 2 Akun (Sistem OTP)</p>
        </div>

        <form id="registerForm" class="space-y-5">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Email Guru</label>
                <input type="email" id="regEmail" required 
                    class="w-full p-4 bg-gray-900 border border-gray-800 rounded-2xl text-white focus:border-blue-500 outline-none transition"
                    placeholder="Contoh: guru@gmail.com">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Password</label>
                <input type="password" id="regPass" required 
                    class="w-full p-4 bg-gray-900 border border-gray-800 rounded-2xl text-white focus:border-blue-500 outline-none transition"
                    placeholder="Minimal 6 karakter">
            </div>

            <button type="submit" id="btnRegister" 
                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl transition shadow-lg shadow-blue-900/20 uppercase tracking-widest">
                KIRIM KODE OTP KE EMAIL
            </button>
        </form>

        <div class="mt-8 text-center">
            <p class="text-gray-500 text-sm">Sudah punya akun? 
                <a href="/login.html" class="text-blue-500 font-bold hover:underline">Login Disini</a>
            </p>
        </div>
    </div>

    <div id="otpModal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-6 z-50">
        <div class="glass w-full max-w-sm p-8 rounded-[40px] text-center border border-gray-700">
            <div class="text-5xl mb-4">ðŸ“§</div>
            <h3 class="text-xl font-black text-white uppercase mb-2">Verifikasi Email</h3>
            <p class="text-gray-400 text-sm mb-6">Masukkan 6 digit kode yang dikirim ke email anda</p>
            
            <input type="text" id="otpCode" placeholder="000000" maxlength="6" 
                class="otp-input w-full p-4 bg-gray-900 text-blue-500 rounded-2xl font-black border border-gray-700 outline-none focus:border-blue-500 mb-4">
            
            <button onclick="verifikasiSekarang()" id="btnVerify"
                class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl uppercase tracking-widest shadow-lg">
                KONFIRMASI KODE
            </button>
            <button onclick="document.getElementById('otpModal').classList.add('hidden')" class="mt-4 text-gray-500 text-xs font-bold uppercase">Batal</button>
        </div>
    </div>

    <script>
        // FUNGSI UNTUK MENDAPATKAN ID UNIK HP (ANTI-SPAM)
        function getDeviceId() {
            const info = navigator.userAgent + screen.width + (navigator.hardwareConcurrency || "unknown");
            return btoa(info); //
        }

        const regForm = document.getElementById('registerForm');
        const otpModal = document.getElementById('otpModal');

        // TAHAP 1: KIRIM DATA PENDAFTARAN & REQUEST OTP
        regForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnRegister');
            const email = document.getElementById('regEmail').value.toLowerCase().trim();
            const password = document.getElementById('regPass').value;

            btn.innerText = "MENGIRIM OTP...";
            btn.disabled = true;

            try {
                const res = await fetch('/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email, 
                        password: password, 
                        deviceId: getDeviceId() // Kirim Device ID ke server
                    })
                });

                const result = await res.json();

                if (res.ok && result.success) {
                    // Munculkan modal OTP jika pendaftaran tahap awal berhasil
                    otpModal.classList.remove('hidden');
                } else {
                    alert(result.error || "Gagal mendaftar. Email mungkin sudah digunakan atau limit HP tercapai.");
                    btn.innerText = "KIRIM KODE OTP KE EMAIL";
                    btn.disabled = false;
                }
            } catch (err) {
                alert("Kesalahan Server: Pastikan koneksi internet stabil.");
                btn.disabled = false;
            }
        };

        // TAHAP 2: VERIFIKASI KODE OTP DARI EMAIL
        async function verifikasiSekarang() {
            const email = document.getElementById('regEmail').value.toLowerCase().trim();
            const otp = document.getElementById('otpCode').value.trim();
            const btn = document.getElementById('btnVerify');

            if(otp.length < 6) return alert("Masukkan 6 digit kode!");

            btn.innerText = "SEDANG VERIFIKASI...";
            btn.disabled = true;

            try {
                const res = await fetch('/auth/verify-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, otp: otp }) // Kirim ke route verifikasi
                });

                const result = await res.json();

                if (res.ok && result.success) {
                    alert("AKUN AKTIF! Silakan login di halaman utama.");
                    window.location.href = '/login.html'; // Pindah ke login
                } else {
                    alert(result.message || "Kode OTP Salah atau sudah tidak berlaku!");
                    btn.innerText = "KONFIRMASI KODE";
                    btn.disabled = false;
                }
            } catch (err) {
                alert("Gagal koneksi ke server.");
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
